<!DOCTYPE html>
<html>

<head>
    <title>首页 {$site_info.site_name|default=''}</title>
    <meta name="keywords" content="{$site_info.site_seo_keywords|default=''}" />
    <meta name="description" content="{$site_info.site_seo_description|default=''}">
    {include file='../public/header' /}
    <link href="/template/web/{$templateName}/public/static/css/course.css" rel="stylesheet">
    <style type="text/css">
    .info-box .ribbon-wrapper {
        display: none;
    }
    </style>
</head>

<body class="hold-transition layout-top-nav">
    <div class="wrapper">
        {include file='../public/nav' /}
        <div class="content-wrapper">
            <div class="content">
                <div class="container">
                    <br>
                    <div class="row bg-white">
                        <div class="col-md-12 mt-4">
                            <strong class="p-2 mt-4">
                                确认订单
                            </strong>
                            <hr>
                        </div>
                        <div class="col-md-12">
                            <div class="row">
                                <div class="col-md-4 col-sm-12">
                                    <a href="javascript:;">
                                        <img src="{$info.image_url ? getUrlPath($info.image_url) :'__STATIC__/img/paybg.png'}" width="100%">
                                    </a>
                                </div>
                                <div class="col-md-4 col-sm-12">
                                    <div class="p-2">
                                        <p class="text-muted font-weight-bold">
                                            {if input('param.type') == 'vip'}
                                            <p class="text-warning">
                                                <strong>
                                                    {$info.title}
                                                </strong>
                                            </p>
                                            {else /}
                                            <a href="{:url('/course',['id'=>$info['id']])}">
                                                {$info.title}
                                            </a>
                                            {/if}
                                        </p>
                                        <p class="text-muted">
                                            <small>
                                                {$info.description}
                                            </small>
                                        </p>
                                        <p>
                                            <strong class="font-weight-bold">¥{$info.price}</strong>
                                        </p>
                                    </div>
                                </div>
                                <div class="col-md-4 col-sm-12">
                                    <div class="p-2" id="payImage"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row bg-white">
                        <div class="col-md-12 mt-4">
                            <strong class="p-2">
                                支付方式
                            </strong>
                            <hr>
                        </div>
                        <div class="col-md-3 col-sm-6 col-12 mt-4">
                            <div class="info-box">
                                <div class="ribbon-wrapper aliPay">
                                    <div class="ribbon bg-info">
                                        支付宝
                                    </div>
                                </div>
                                <span class="info-box-icon">
                                    <!-- <i class="far fa-envelope"></i> -->
                                    <img width="80" height="80" src="/template/web/{$templateName}/public/static/img/aliPay.svg" />
                                </span>
                                <input type="hidden" value="1" id="pay">
                                <div class="info-box-content">
                                    <span class="info-box-text">使用支付宝支付</span>
                                    <span class="info-box-number text-danger">¥{$info.price}</span>
                                </div>
                                <!-- /.info-box-content -->
                            </div>
                            <!-- /.info-box -->
                        </div>
                        <div class="col-md-3 col-sm-6 col-12 mt-4">
                            <div class="info-box">
                                <span class="info-box-icon">
                                    <div class="ribbon-wrapper wechatPay">
                                        <div class="ribbon bg-info">
                                            微信支付
                                        </div>
                                    </div>
                                    <!-- <i class="far fa-envelope"></i> -->
                                    <img width="80" height="80" src="/template/web/{$templateName}/public/static/img/wechatPay.svg" />
                                </span>
                                <input type="hidden" value="2" id="pay">
                                <div class="info-box-content">
                                    <span class="info-box-text">使用微信支付</span>
                                    <span class="info-box-number text-danger">¥{$info.price}</span>
                                </div>
                                <!-- /.info-box-content -->
                            </div>
                            <!-- /.info-box -->
                        </div>
                        <input type="hidden" name="payType" id="payType" value="0">
                        <div class="col-md-12 mt-4 mb-4">
                            <button id="coursePay" class="btn btn-primary btn-sm btn-danger">立即支付</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <aside class="control-sidebar control-sidebar-dark">
        <!-- Control sidebar content goes here -->
        <div class="p-3">
            <h5>Title</h5>
            <p>Sidebar content</p>
        </div>
    </aside>
    {include file='../public/footer' /}
    </div>
    {include file='../public/script' /}
    <script src="https://cdn.bootcss.com/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
    <script type="text/javascript">
    $(".info-box").click(function() {

        $('.ribbon-wrapper').hide();
        $(this).find('.ribbon-wrapper').toggle();
        var value = $(this).find('#pay').val();
        $("#payType").val(value);

    });


    $("#coursePay").click(function(event) {

        event.preventDefault();

        var payType = $('#payType').val();
        var id = "{:input('param.id')}";
        var type = "{$info.type}";

        $.post("{:url('/pay/pay')}", { payType: payType, id: id, type: type }, function(json) {

            console.log(json)
            if (json.code == 1) {

                if (json.data.mobile == 1) {

                    success(json.msg);
                    setTimeout(function() {
                        window.open(json.data.src)
                    }, 1000);
                    // StatisticsPanel

                } else {

                    $("#payImage").empty();
                    $("#payImage").qrcode(json.data.src);


                    var getting = {

                        url: "{:url('/pay/payStatus')}",
                        dataType: 'json',
                        data: { "order_id": json.data.order_id },
                        success: function(res) {
                            if (res.code == 1) {

                                success(json.msg);
                                setTimeout(function() {
                                    window.location.href = "/";
                                }, 1000);

                            }
                        }
                    };



                    var timesRun = 0;
                    var interval = setInterval(function() {
                        timesRun += 1; //每刷新一次 timesRun 就+1
                        if (timesRun === 9) {
                            clearInterval(interval);
                        }
                        $.ajax(getting)
                        //这里写你的代码
                    }, 2000);

                }

            } else {

                error(json.msg);
                setTimeout(function() {
                    window.location.href = "/";
                }, 1000);
            }

        }, "json");



    });
    </script>
</body>

</html>